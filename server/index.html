<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Image/Manga Translator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.min.css"/>
    <style>
        [v-cloak],
        [un-cloak] { display: none; }
        /* Additional simple styling */
        #finishedMessage { display: none; background-color: #ccffcc; color: #006600; padding: 10px; border: 1px solid #006600; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); }
        #downloadList { position: fixed; bottom: 10px; right: 10px; background: #fff; padding: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <!-- Simplified plain HTML upload form -->
    <form id="uploadForm">
        <input type="file" id="fileInput" accept="image/png,image/jpeg,image/bmp,image/webp,application/zip,application/x-zip-compressed">
        <button type="submit">Upload</button>
    </form>

    <!-- Status and finished message containers -->
    <div id="statusMessage"></div>
    <div id="finishedMessage"></div>

    <!-- Container for finished download buttons -->
    <div id="downloadList">
        <h3>Download Translated Zips</h3>
    </div>

    <script>
    // Pure vanilla JS solution
    (function(){
        var fileInput = document.getElementById('fileInput');
        var uploadForm = document.getElementById('uploadForm');
        var statusMsg = document.getElementById('statusMessage');
        var finishedMsg = document.getElementById('finishedMessage');
        var downloadList = document.getElementById('downloadList');
        var BASE_URI = '/';

        uploadForm.addEventListener('submit', function(e){
            e.preventDefault();
            var file = fileInput.files[0];
            if(!file){
                statusMsg.innerHTML = "No file selected.";
                return;
            }
            // Only support zip files for this example.
            if(!(file.type === "application/zip" || file.type === "application/x-zip-compressed")){
                statusMsg.innerHTML = "Only ZIP files are supported.";
                return;
            }
            statusMsg.innerHTML = "Uploading...";
            var formData = new FormData();
            formData.append('image', file);
            // Sample static config; adjust as needed.
            formData.append('config', '{"detector": {"detector":"default","detection_size":2048},"render": {"direction":"horizontal"},"translator": {"translator":"gemini-2.0-flash-exp","target_lang":"KOR"}}');

            // Call zip-submit API
            fetch(BASE_URI + 'translate/with-form/zip-submit', {
                method: 'POST',
                body: formData
            })
            .then(function(response){ return response.json(); })
            .then(function(json){
                var jobId = json.job_id;
                statusMsg.innerHTML = "Processing ZIP job...";
                // Poll for job status.
                function pollStatus(){
                    fetch(BASE_URI + 'translate/with-form/zip-status/' + jobId)
                    .then(function(resp){ return resp.json(); })
                    .then(function(statusJson){
                        console.log("Polling job", jobId, "status:", statusJson.status);
                        var currStatus = statusJson.status.trim();
                        if(currStatus === "finished"){
                            statusMsg.innerHTML = "Job finished.";
                            var origName = file.name || "download.zip";
                            var translatedName = origName.replace(/\.zip$/i, "") + "-translated.zip";
                            // Create a container for this job.
                            var container = document.createElement("div");
                            // Download button
                            var downloadBtn = document.createElement("button");
                            downloadBtn.innerHTML = "Download " + translatedName;
                            downloadBtn.onclick = function(){
                                window.location.href = BASE_URI + 'translate/with-form/zip-download/' + jobId;
                            };
                            // Delete button
                            var deleteBtn = document.createElement("button");
                            deleteBtn.innerHTML = "Delete";
                            deleteBtn.style.marginLeft = "10px";
                            deleteBtn.onclick = function(){
                                fetch(BASE_URI + 'translate/with-form/zip-delete/' + jobId, { method: "DELETE" })
                                .then(function(resp){
                                    if(resp.ok){
                                        downloadList.removeChild(container);
                                    }
                                });
                            };
                            container.appendChild(downloadBtn);
                            container.appendChild(deleteBtn);
                            downloadList.appendChild(container);
                            // Show finished message for 5 seconds.
                            finishedMsg.style.display = "block";
                            finishedMsg.innerHTML = "Translation completed successfully!";
                            setTimeout(function(){
                                finishedMsg.style.display = "none";
                            }, 5000);
                        } else if(currStatus === "error"){
                            statusMsg.innerHTML = "Job error: " + statusJson.error;
                        } else {
                            setTimeout(pollStatus, 2000);
                        }
                    })
                    .catch(function(err){
                        console.error(err);
                        statusMsg.innerHTML = "Polling error.";
                    });
                }
                pollStatus();
            })
            .catch(function(err){
                console.error(err);
                statusMsg.innerHTML = "Upload error.";
            });
        });
    })();
    </script>
</body>
</html>
